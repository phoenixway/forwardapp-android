# –í–∞–∂–ª–∏–≤—ñ –Ω–æ—Ç–∞—Ç–∫–∏ –ø–æ –º—ñ–≥—Ä–∞—Ü—ñ—ó –Ω–∞ KMP + SQLDelight

–¶–µ–π –¥–æ–∫—É–º–µ–Ω—Ç —î –∑–±—ñ—Ä–∫–æ—é –∫–ª—é—á–æ–≤–∏—Ö –ø—Ä–∞–≤–∏–ª —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫, –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –ø—ñ–¥ —á–∞—Å –º—ñ–≥—Ä–∞—Ü—ñ—ó –ø—Ä–æ—î–∫—Ç—É.

---

## 1. –Ø–∫ SQLDelight –ø—Ä–∞—Ü—é—î –∑ —ñ–º–µ–Ω–∞–º–∏

### 1.1. –Ü–º–µ–Ω—É–≤–∞–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—å (`CREATE TABLE`)

SQLDelight –±—É–∫–≤–∞–ª—å–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —ñ–º'—è —Ç–∞–±–ª–∏—Ü—ñ –∑ `.sq` —Ñ–∞–π–ª—É –≤ –Ω–∞–∑–≤—É –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö –∫–ª–∞—Å—ñ–≤.

*   **–Ø–∫—â–æ —Ç–∞–±–ª–∏—Ü—è –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è `link_items` (snake_case):**
    *   –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π data class: `Link_items`
    *   –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –∫–ª–∞—Å –∑–∞–ø–∏—Ç—ñ–≤: `Link_itemsQueries`
    *   –ó–≤–µ—Ä–Ω–µ–Ω–Ω—è –≤ Kotlin: `db.link_itemsQueries` (—Ç–∞–∫, –∑ –ø—ñ–¥–∫—Ä–µ—Å–ª–µ–Ω–Ω—è–º)

*   **–Ø–∫—â–æ –Ω–∞–∑–≤–∞ —Ç–∞–±–ª–∏—Ü—ñ `ProjectExecutionLogs` (PascalCase):**
    *   –ö–ª–∞—Å –¥–∞–Ω–∏—Ö: `ProjectExecutionLogs`
    *   –ö–ª–∞—Å –∑–∞–ø–∏—Ç—ñ–≤: `ProjectExecutionLogsQueries`
    *   –ó–≤–µ—Ä–Ω–µ–Ω–Ω—è –≤ Kotlin: `db.projectExecutionLogsQueries`

> **‚ùóÔ∏è –í–∞–∂–ª–∏–≤–æ:** SQLDelight –Ω–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î `snake_case` —É `PascalCase` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ. –©–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –Ω–µ–∑—Ä—É—á–Ω–∏—Ö —ñ–º–µ–Ω –≤ Kotlin (`db.link_itemsQueries`), **–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `PascalCase` –¥–ª—è –Ω–∞–∑–≤ —Ç–∞–±–ª–∏—Ü—å** —É `.sq` —Ñ–∞–π–ª–∞—Ö.
>
> ```sql
> CREATE TABLE ProjectExecutionLogs (...);
> CREATE TABLE LinkItems (...);
> CREATE TABLE DailyMetrics (...);
> ```

### 1.2. –Ü–º–µ–Ω—É–≤–∞–Ω–Ω—è –∫–æ–ª–æ–Ω–æ–∫

–ù–∞–∑–≤–∏ –∫–æ–ª–æ–Ω–æ–∫ —Ç–∞–∫–æ–∂ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—å—Å—è –±—É–∫–≤–∞–ª—å–Ω–æ.

*   `project_id` -> `project_id`
*   `createdAt` -> `createdAt`

> **üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:** –©–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç–µ–π –º—ñ–∂ –ë–î —Ç–∞ –¥–æ–º–µ–Ω–Ω–æ—é –º–æ–¥–µ–ª–ª—é, –Ω–∞–∑–∏–≤–∞–π—Ç–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ `camelCase` –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ —É `.sq` —Ñ–∞–π–ª–∞—Ö (`projectId`, `createdAt` —ñ —Ç.–¥.). –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ ‚Äî —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –º–∞–ø–ø–µ—Ä –¥–ª—è –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ–≥–æ –∫–ª–∞—Å—É –≤ –¥–æ–º–µ–Ω–Ω–∏–π.

### 1.3. –Ü–º–µ–Ω–∞ –∑–∞–ø–∏—Ç—ñ–≤

–Ü–º–µ–Ω–∞, —â–æ –≤–∏ –¥–∞—î—Ç–µ –∑–∞–ø–∏—Ç–∞–º, —Å—Ç–∞—é—Ç—å –Ω–∞–∑–≤–∞–º–∏ —Ñ—É–Ω–∫—Ü—ñ–π —É –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö `...Queries` –∫–ª–∞—Å–∞—Ö.

*   **`.sq` —Ñ–∞–π–ª:**
    ```sql
    selectAllByProjectId:
    SELECT * FROM ProjectExecutionLogs WHERE projectId = :projectId;
    ```
*   **–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π Kotlin-–∫–æ–¥:**
    ```kotlin
    fun selectAllByProjectId(projectId: String): Query<ProjectExecutionLogs>
    ```

---

## 2. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É –≤ SQLDelight 2.x

### 2.1. –†–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è `.sq` —Ñ–∞–π–ª—ñ–≤

–§–∞–π–ª–∏ —Å—Ö–µ–º–∏ —Ç–∞ –∑–∞–ø–∏—Ç—ñ–≤ –º–∞—é—Ç—å –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏—Å—å –∑–∞ –Ω–∞—Å—Ç—É–ø–Ω–∏–º —à–ª—è—Ö–æ–º –¥–ª—è `commonMain`:
```
shared/
 ‚îî‚îÄ‚îÄ src/
      ‚îî‚îÄ‚îÄ commonMain/
           ‚îî‚îÄ‚îÄ sqldelight/
                ‚îî‚îÄ‚îÄ <package_name>/  <-- –¶–µ–π —à–ª—è—Ö —Å—Ç–∞–Ω–µ –ø–∞–∫–µ—Ç–æ–º –¥–ª—è –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ–≥–æ –∫–æ–¥—É
                     ‚îî‚îÄ‚îÄ *.sq
```
*–ü—Ä–∏–∫–ª–∞–¥:* `shared/src/commonMain/sqldelight/com/romankozak/db/Project.sq` –∑–≥–µ–Ω–µ—Ä—É—î –∫–ª–∞—Å–∏ –≤ –ø–∞–∫–µ—Ç—ñ `com.romankozak.db`.

### 2.2. –î–µ —à—É–∫–∞—Ç–∏ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏

–£ –≤–µ—Ä—Å—ñ—ó SQLDelight 2.x –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –∫–æ–¥ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è —Ç—É—Ç:
```
shared/build/generated/sqldelight/code/<DatabaseName>/commonMain/
```
*–ü—Ä–∏–∫–ª–∞–¥:* `shared/build/generated/sqldelight/code/ForwardAppDatabase/commonMain/com/romankozak/db/`

### 2.3. –Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é

*   **–ó–∞–ø—É—Å—Ç–∏—Ç–∏ Gradle-–∑–∞–≤–¥–∞–Ω–Ω—è:**
    ```bash
    ./gradlew :shared:generateSqlDelightInterface
    ```
*   **–ó–Ω–∞–π—Ç–∏ —Ñ–∞–π–ª–∏ –≤—Ä—É—á–Ω—É:**
    ```bash
    find shared/build/generated -name "ForwardAppDatabase.kt"
    find shared/build/generated -name "*Queries.kt"
    ```

### 2.4. –Ø–∫—â–æ IDE –Ω–µ –±–∞—á–∏—Ç—å –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ –∫–ª–∞—Å–∏

1.  –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ `.sq` —Ñ–∞–π–ª–∏ –ª–µ–∂–∞—Ç—å —É –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó (`src/commonMain/sqldelight`).
2.  –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü—ñ—é: `./gradlew clean && ./gradlew :shared:generateSqlDelightInterface`.
3.  –í Android Studio: `File` -> `Invalidate Caches / Restart`.

---

## 3. –û–±—Ä–æ–±–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–∏—Ö —Ç–∏–ø—ñ–≤: –ü–∞—Å—Ç–∫–∞ –∑ `Float` —Ç–∞ `Map`

SQLDelight –Ω–µ –≤–º—ñ—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–≤–æ–¥–∏—Ç–∏ —Å–∫–ª–∞–¥–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ —Ç–∏–ø–∏.

### 3.1. –ü—Ä–æ–±–ª–µ–º–∞

–ö–æ–ª–∏ –≤–∏ –≤–∫–∞–∑—É—î—Ç–µ —É `.sq` —Ñ–∞–π–ª—ñ —Ç–∏–ø `REAL AS kotlin.Float` –∞–±–æ `TEXT AS Map<String, Float>`, –ø–ª–∞–≥—ñ–Ω SQLDelight –Ω–∞ –µ—Ç–∞–ø—ñ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∫–æ–¥—É –Ω–µ –º–æ–∂–µ –∑–Ω–∞–π—Ç–∏ —Ü—ñ —Ç–∏–ø–∏, –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–Ω –Ω–µ –º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ `kotlin-stdlib`. –¶–µ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç—å –¥–æ –ø–æ–º–∏–ª–æ–∫ `Unresolved reference`.

*   `REAL` —É SQLite –∑–∞–≤–∂–¥–∏ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —è–∫ `Double`. SQLDelight –ø—ñ–¥—Ç—Ä–∏–º—É—î –º–∞–ø—ñ–Ω–≥ `REAL` ‚Üî `Double` "–∑ –∫–æ—Ä–æ–±–∫–∏", –∞–ª–µ –Ω–µ `Float`.
*   –°–∫–ª–∞–¥–Ω—ñ —Ç–∏–ø–∏, —è–∫ `Map` –∞–±–æ `List`, –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å–µ—Ä—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –≤ `TEXT`.

### 3.2. –†—ñ—à–µ–Ω–Ω—è (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–µ)

1.  **–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `Double` —É SQL:** –ó–∞–º—ñ—Å—Ç—å `Float`, –∑–∞–≤–∂–¥–∏ –≤–∫–∞–∑—É–π—Ç–µ `Double`.
    ```sql
    -- –ü—Ä–∞–≤–∏–ª—å–Ω–æ
    myColumn REAL AS kotlin.Double NOT NULL,
    -- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
    myColumn REAL AS kotlin.Float NOT NULL
    ```

2.  **–°–µ—Ä—ñ–∞–ª—ñ–∑—É–π—Ç–µ —Å–∫–ª–∞–¥–Ω—ñ —Ç–∏–ø–∏ –≤ `TEXT`:** –î–ª—è `Map`, `List` –∞–±–æ –≤–ª–∞—Å–Ω–∏—Ö –∫–ª–∞—Å—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `TEXT` —ñ –∞–¥–∞–ø—Ç–µ—Ä, —â–æ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —ó—Ö —É JSON-—Ä—è–¥–æ–∫.
    ```sql
    -- –í–∫–∞–∑—É—î–º–æ, —â–æ —Ü–µ Map, –∞–ª–µ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —è–∫ TEXT
    customMetrics TEXT AS kotlin.collections.Map<kotlin.String, kotlin.Double>
    ```

3.  **–°—Ç–≤–æ—Ä—ñ—Ç—å `ColumnAdapter`:**
    ```kotlin
    // –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è Map<String, Double> -> String
    private val customMetricsAdapter = object : ColumnAdapter<Map<String, Double>, String> {
        override fun decode(databaseValue: String): Map<String, Double> =
            Json.decodeFromString(databaseValue)
        override fun encode(value: Map<String, Double>): String =
            Json.encodeToString(value)
    }
    ```

4.  **–ö–æ–Ω–≤–µ—Ä—Ç—É–π—Ç–µ —Ç–∏–ø–∏ –≤ –º–∞–ø–ø–µ—Ä—ñ:** –ù–∞ —Ä—ñ–≤–Ω—ñ –≤–∞—à–æ–≥–æ –∫–æ–¥—É, –ø—Ä–∏ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ—ó SQLDelight-—Å—É—Ç–Ω–æ—Å—Ç—ñ –≤ –¥–æ–º–µ–Ω–Ω—É –º–æ–¥–µ–ª—å, –∫–æ–Ω–≤–µ—Ä—Ç—É–π—Ç–µ `Double` –Ω–∞–∑–∞–¥ —É `Float`.
    ```kotlin
    fun DailyMetrics.toDomain(): DomainDailyMetric {
        return DomainDailyMetric(
            // ...
            customMetrics = this.customMetrics?.mapValues { it.value.toFloat() }
        )
    }
    ```

### 3.3. –ì–æ–ª–æ–≤–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞

*   **–ù–µ —Ä–µ–¥–∞–≥—É–π—Ç–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏.** –í–æ–Ω–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—é—Ç—å—Å—è –ø—Ä–∏ –∫–æ–∂–Ω—ñ–π –∑–±—ñ—Ä—Ü—ñ.
*   **SQLDelight –Ω–µ –≤–∏–≤–æ–¥–∏—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ —Ç–∏–ø–∏.** –£—Å—ñ –∫–æ–ª–æ–Ω–∫–∏ –≤ `.sq` —Ñ–∞–π–ª–∞—Ö –º–∞—é—Ç—å –±—É—Ç–∏ –±–∞–∑–æ–≤–∏–º–∏ —Ç–∏–ø–∞–º–∏ (`TEXT`, `INTEGER`, `REAL`, `BLOB`), –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ –∑ `AS <KotlinType>`, –¥–µ `<KotlinType>` ‚Äî —Ü–µ —Ç–∏–ø, —è–∫–∏–π –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ —É –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ–º—É –∫–æ–¥—ñ —ñ –¥–ª—è —è–∫–æ–≥–æ –≤–∏ –Ω–∞–¥–∞—Å—Ç–µ –∞–¥–∞–ø—Ç–µ—Ä.