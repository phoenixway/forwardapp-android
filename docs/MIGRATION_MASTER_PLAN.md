# Майстер-план міграції на KMP + SQLDelight

Цей документ окреслює покроковий план для поступового повернення функціоналу в проєкт після переходу на мінімально компілюючу конфігурацію з Kotlin Multiplatform, SQLDelight та `kotlin-inject`.

**Основна стратегія:** Повертати функціонал з гілки `dev` модуль за модулем, адаптуючи його до нової архітектури. Кожен великий крок має завершуватись компіляцією проєкту.

---

## Архітектурні принципи

1.  **Package by Feature (Пакет за функціоналом):** Весь код, що стосується однієї функціональності (наприклад, "Проекти", "Цілі"), має бути згрупований в одному пакеті. Це стосується моделей даних, репозиторіїв, мапперів тощо.
2.  **One Entity per File (Одна сутність на файл):** Кожна доменна модель (наприклад, `Project`, `Goal`) має знаходитись в окремому файлі. Не створювати один великий файл `CoreDataModels.kt`.

---

## Фаза 1: Завершення налаштування інфраструктури

- [x] **Фіналізація DI:**
    - [x] Створити базові модулі для `kotlin-inject` (наприклад, `DatabaseModule`, `RepositoryModule`), щоб забезпечити `ForwardAppDatabase` та репозиторії.
    - [x] Налаштувати надання `CoroutineDispatcher` (IO, Default, Main) через DI.
- [x] **Базові репозиторії:**
    - [x] Визначити базовий інтерфейс `BaseRepository` (якщо є спільна логіка). (Пропущено, оскільки немає очевидної спільної логіки на цьому етапі)
- [x] **Структура мапперів:**
    - [x] Створити директорії для мапперів, які будуть перетворювати SQLDelight-сутності в доменні моделі.

---

## Фаза 2: Відновлення базового шару даних (Проекти та Цілі)

Мета цієї фази — відновити основні моделі даних `Project`, `Goal` та `ListItem`, що дозволить реалізувати базовий функціонал списку проектів та їх вмісту, дотримуючись архітектурних принципів.

- [ ] **Створити структуру пакетів за функціоналом:**
    - [ ] Створити пакет `shared/src/commonMain/kotlin/com/romankozak/forwardappmobile/shared/features/projects` для всього, що стосується проектів.
    - [ ] Створити пакет `shared/src/commonMain/kotlin/com/romankozak/forwardappmobile/shared/features/goals` для всього, що стосується цілей.
- [ ] **Відновити доменні моделі (окремими файлами):**
    - [ ] У пакеті `.../features/projects/data/models/`, створити файли для `Project.kt`, `RelatedLink.kt`, `ProjectType.kt` та інших залежних сутностей.
    - [ ] У пакеті `.../features/goals/data/models/`, створити файл `Goal.kt`.
    - [ ] У пакеті `.../features/projects/data/models/`, створити файл `ListItem.kt` (оскільки він пов'язує елементи всередині проекту).
- [ ] **Створити схеми SQLDelight:**
    - [ ] Створити файл `Projects.sq` з `CREATE TABLE` для таблиці `Projects`.
    - [ ] Створити файл `Goals.sq` з `CREATE TABLE` для таблиці `Goals`.
    - [ ] Створити файл `ListItems.sq` з `CREATE TABLE` для таблиці `ListItems`.
- [ ] **Налаштувати адаптери бази даних:**
    - [ ] Оновити `DatabaseDriverFactory.kt`, додавши необхідні `ColumnAdapter` для нових таблиць.
    - [ ] Оновити функцію `createForwardAppDatabase`, щоб передати нові адаптери в конструктор `ForwardAppDatabase`.
- [ ] **Створити репозиторії та маппери (у відповідних feature-пакетах):**
    - [ ] **Принцип:** Не відновлювати старі репозиторії повністю, якщо це створить проблеми, які не є актуально важливими для вирішення зараз. На основі старого коду створювати нові, чисті реалізації лише з методами, необхідними для поточної віхи.
    - [ ] Створити `.../features/projects/data/repository/ProjectRepository.kt` (інтерфейс) з методами для отримання всіх проектів та одного проекту за ID.
    - [ ] Створити `.../features/projects/data/repository/ProjectRepositoryImpl.kt` з мінімальною реалізацією.
    - [ ] Створити `.../features/goals/data/repository/GoalRepository.kt` (інтерфейс) з методом для отримання цілей за списком ID.
    - [ ] Створити `.../features/goals/data/repository/GoalRepositoryImpl.kt`.
    - [ ] Створити `.../features/projects/data/repository/ListItemRepository.kt` (інтерфейс) з методом для отримання елементів списку для даного проекту.
    - [ ] Створити `.../features/projects/data/repository/ListItemRepositoryImpl.kt`.
    - [ ] Створити маппери для `Project`, `Goal`, `ListItem` у відповідних пакетах (`.../features/projects/data/mappers/`).
- [ ] **Перевірка:**
    - [ ] Запустити `./gradlew clean assembleDebug` і переконатись, що проєкт компілюється з новим шаром даних.
- [ ] **Тестування:**
    - [ ] Створити тести для `ProjectRepository`, `GoalRepository`, `ListItemRepository`, щоб перевірити коректність запитів до бази даних та маппінгу.

---

## Фаза 3: Поступова міграція функціоналу

Для кожного функціонального блоку потрібно виконати наступні кроки. Порядок міграції можна змінювати, але рекомендується починати з менш залежних модулів.

### Модуль 1: Цілі (Goals)

- [ ] **Відновити схему:**
    - [ ] Перемістити `Goal.sq` з `sqldelight_backup` до `shared/src/commonMain/sqldelight/...`.
    - [ ] Виправити синтаксис та типи в `Goal.sq` відповідно до нотаток (використовувати `PascalCase` для таблиці, `camelCase` для колонок, `Double` замість `Float`).
- [ ] **Оновити адаптери:**
    - [ ] Додати/оновити необхідні `ColumnAdapter` в `DatabaseDriverFactory.kt` для кастомних типів з `Goal.sq`.
- [ ] **Відновити код:**
    - [ ] Відновити доменну модель `Goal.kt` з гілки `dev`.
    - [ ] Створити маппер `GoalMapper.kt` (`fun Goals.toDomain(): Goal`).
    - [ ] Відновити `GoalRepository` (інтерфейс) та `GoalRepositoryImpl` (реалізацію), замінивши прямі запити до Room/старого SQLDelight на виклики `goalQueries`.
- [ ] **Інтеграція:**
    - [ ] Додати `GoalRepository` в DI-компонент.
    - [ ] Відновити `GoalViewModel` (або аналог), підключивши до нього репозиторій.
    - [ ] Відновити UI для відображення цілей.
- [ ] **Перевірка:**
    - [ ] Запустити `./gradlew clean assembleDebug` і переконатись, що проєкт компілюється.

### Модуль 2: Проєкти (Projects)

- [ ] **Відновити схему:**
    - [ ] Перемістити `Projects.sq`, `ProjectArtifacts.sq`, `ProjectExecutionLogs.sq`, `ProjectAttachmentCrossRef.sq`.
    - [ ] Виправити синтаксис та типи.
- [ ] **Оновити адаптери:**
    - [ ] Додати необхідні `ColumnAdapter` в `DatabaseDriverFactory.kt`.
- [ ] **Відновити код:**
    - [ ] Відновити доменні моделі (`Project`, `ProjectArtifact` і т.д.).
    - [ ] Створити маппери.
    - [ ] Відновити `ProjectRepository` та його реалізацію.
- [ ] **Інтеграція та перевірка:**
    - [ ] Додати репозиторій в DI.
    - [ ] Відновити ViewModel та UI.
    - [ ] Перевірити компіляцію.

### Модуль 3: Завдання та Списки (Tasks & Lists)

- [ ] **Відновити схему:**
    - [ ] Перемістити `DayTasks.sq`, `ListItems.sq`, `Checklists.sq`, `ChecklistItems.sq`, `RecurringTasks.sq`.
    - [ ] Виправити синтаксис та типи.
- [ ] **Оновити адаптери:**
    - [ ] Додати необхідні `ColumnAdapter`.
- [ ] **Відновити код:**
    - [ ] Відновити доменні моделі (`Task`, `ListItem` і т.д.).
    - [ ] Створити маппери.
    - [ ] Відновити відповідні репозиторії.
- [ ] **Інтеграція та перевірка:**
    - [ ] Додати репозиторії в DI.
    - [ ] Відновити ViewModel та UI.
    - [ ] Перевірити компіляцію.

### Модуль 4: Нотатки (Notes)

- [ ] **Відновити схему:**
    - [ ] Перемістити `Notes.sq`, `NoteDocuments.sq`, `NoteDocumentItems.sq`.
    - [ ] Розглянути, як мігрувати `LegacyNote.sq`, якщо це потрібно.
- [ ] **Оновити адаптери та код** (за аналогією з попередніми модулями).
- [ ] **Інтеграція та перевірка.**

### Модуль 5: Щоденне планування (Daily Planning)

- [ ] **Відновити схему:**
    - [ ] Перемістити `DayPlan.sq`, `DailyMetrics.sq`.
- [ ] **Оновити адаптери та код.**
- [ ] **Інтеграція та перевірка.**

### Модуль 6: Інбокс (Inbox)

- [ ] **Відновити схему:**
    - [ ] Перемістити `InboxRecords.sq`.
- [ ] **Оновити адаптери та код.**
- [ ] **Інтеграція та перевірка.**

### Модуль 7: Інші сутності

- [ ] **Відновити схему:**
    - [ ] Перемістити `ActivityRecord.sq`, `Attachments.sq`, `Reminders.sq`, `ConversationFolders.sq`.
- [ ] **Оновити адаптери та код.**
- [ ] **Інтеграція та перевірка.**

---

## Фаза 3: Тестування та Зачистка

- [ ] **Написання тестів:**
    - [ ] Додати Unit-тести для всіх нових репозиторіїв та мапперів.
    - [ ] Додати UI-тести для відновленого функціоналу.
- [ ] **Зачистка:**
    - [ ] Видалити директорії `sqldelight_backup` та `sqldelight_backup_2`.
    - [ ] Видалити всі тимчасові файли (`.bak`) та невикористовуваний код.
    - [ ] Провести фінальний рефакторинг та перевірку коду.
- [ ] **Документація:**
    - [ ] Оновити `README.md` та інші релевантні документи.
