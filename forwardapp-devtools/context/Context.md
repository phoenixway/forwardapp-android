## 1. Поточне завдання (CURRENT TASK)
- **Вирішено:** Усі відомі проблеми з синхронізацією (tombstones, системні проекти, вкладення) були вирішені.

## 3. План дій
- [x] Проаналізовано логіку синхронізації (`SyncRepository.kt`) та виявлено, що `systemKey` не використовувався як стабільний ідентифікатор для системних проектів.
- [x] **Виправлено:** Проведено значний рефакторинг функції `applyServerChanges` в `SyncRepository.kt`.
    -   Нова логіка спочатку ідентифікує системні проекти за `systemKey` і приводить їхні `id` у відповідність до локальної бази даних.
    -   Створюється карта перенаправлення (`idRedirects`) для старих ID.
    -   Ця карта використовується для корекції всіх зовнішніх ключів (`projectId`, `parentId`, `entityId`) у всіх інших сутностях (нотатках, чеклістах, `ListItem` тощо) *перед* тим, як виконувати їх злиття.
- [x] **Результат:** Цей підхід гарантує цілісність даних та коректну синхронізацію системних проектів та всіх пов'язаних з ними вкладень між різними клієнтами, незалежно від їхніх локальних `id`.

## 4. Невирішені проблеми / Блокери (PROBLEMS)
- Десктопний клієнт все ще може некоректно обробляти "tombstone" записи.

## 5. Значимі файли і модулі (IMPORTANT FILES / MODULES)
- `data/repository/SyncRepository.kt` - місце основного виправлення.

## 6. Інструкції та вимоги до стилю (INSTRUCTIONS)

- Не переписувати архітектуру без підтвердження  
- Виконувати лише один крок за раз  
- Не змінювати DI без дозволу  
- Додавати пропозицію оновлення контексту після кожної дії  
- Писати код, що точно компілюється  
- Завжди пояснювати причину помилки  

---

## 7. Замітки для агента (NOTES)
- ідеї в SYNAPSE_DESIGN.md, SYNC_FEATURE_SPEC.md
---

## 8. Після цього
- Можна прибрати додане логування з `GoalRepository` та `SyncRepository`.
---