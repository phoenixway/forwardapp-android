# CONTEXT.md
Документ оперативної пам'яті для агента розробки.
Використовується в кожній сесії.

---

## 1. Поточне завдання (CURRENT TASK)
синхронізація високого рівня

### що є
- є android версія додатку, 
- є десктоп версія додатку. 
- android версія додатку є джерелом правди. 
- зокрема щодо формату json повного бекапу
- версії додатків мають різну архітектуру. часто міняються моделі БД. через це синхронізація між додатками - постійне джерело проблем і багів.
- з вкладеннями (attachments) є специфіка. в андроїд версії зокрема. щоб зрозуміти в чому вона достатньо подивитися як отримуються вкладення в ui бібліотеці вкладень. там з join таблиці. 
- є так звані системні проекти і вкладення. вони мають бути однозначно ідентифіковані через системні ключі. при імпорті має відбуватися коректне оновлення цих сутностей. а не так як зараз коли створюються дублікати при вибірковому імпорті сервіс неправильний метод ініціалізації даних який думає що системних сутностей немає і перетворює їх заново при тому що вони існують.
- є стабільна андроїд версія з room в гілці dev
- є експериментальна андроїд версія з kmp+sqldelight в гілці refactor. 
- остання - спроба мігрувати на універсальну з точки зору багатьох платформ архітектуру. незавершена спроба, але уже викона 70% роботи з міграції. десктоп додаток використовує kmp -> typescript бібліотеку спільну з експериментальною андроїд версією як шар даних
- в перспективі експериментальна версія має замінити поточну стабільну. тобто міняти треба спільний код kmp якщо требьа міняти десктоп додаток
- поточна САМА ГОЛОВНА ЦІЛЬ: «Zero-Friction Sync». Синхронізація між версіями додатка не є дією, яку користувач ініціює. Вона просто відбувається — непомітно, швидко, надійно, у фоновому режимі. Єдиний раз, коли користувач думає про синхронізацію — це коли бачить її статус "Оновлено щойно" і відчуває впевненість. це реалізовано частково, з багами.
- зараз зміни на андроїд версії відображаються на десктопній відносно стабільно. навпаки - взагалі ні

### desktop додаток
- виконує при синхронізації роль винятково клієнта. pull, push. автентифікація поки не реалізована
- Автосинк кожні ~15 с (або після мережевого відновлення):
      1. Читає налаштування defaultWifiImportAddress/defaultLanAddress (хост:порт Android-
      сервера).
      2. Якщо офлайн або адреси немає — чекає.
      3. Pull: GET http://<address>/export, парсить FullAppBackup v2.
      4. LWW-мердж: локальний стан → конвертується у FullAppBackup v2, мерджиться з вхідним
      (пріоритет: version, потім updatedAt, при рівності — вхідні; tombstone має перевагу;
      systemKey/reservedGroup не дублюються).
      5. Застосовує мердж до Redux-стану.
      6. Push: формує наш FullAppBackup v2 і робить POST http://<address>/import.
      7. Оновлює lastSyncAt; при помилці ставить статус error.
- Офлайн: при navigator.onLine === false синк пропускається до відновлення мережі.
- Індикатор синхронізації
- Маленький кружок справа на панелі вкладок:
      - Пульсує зеленим під час синку.
      - Червоний при помилці.
      - Сірий при офлайні.
      - Натискання відкриває модал “Стан синхронізації” (поточний статус, останній успіх,
      адреса сервера, остання помилка, кнопка “Налаштування”).
- Адреса в модалі будується з налаштувань або з даних сервера (LAN статус).
- Формати й LWW
- Експорт/імпорт — FullAppBackup v2 з sync-полями (version, updatedAt, syncedAt, isDeleted).
- Під час мерджу: version > updatedAt (null=0) > вхідні виграють; tombstone з новішою
свіжістю видаляє/деактивує локальний запис; syncedAt не впливає на конфлікт.
- Налаштування
      - Адреса Android-сервера: у налаштуваннях (поле “Адреса для імпорту за замовчуванням”),
      використовується і для автосинку, і для імпорту через модал.
      - Порт/директорія серверної сторони: FORWARDAPP_PORT/PORT, FORWARDAPP_EXPORT_DIR через env.

### андроїд версія
- адреса десктоп додатку, вмикання автосинхронізації задається в налаштуваннях
- виконує роль сервера синхронізації

### цілі
- працюємо поки тільки з андроїд версією додатку 
- Я хотів би зробити щоб android додаток повністю ідеально працював щодо синхронізації
      - міг імпортувати такого самого формату json файли.
            - варіанти імпорту 
                  - повністю (заміняє все що було до цього) 
                  - вибірково, тобто користувачу показується екран імпорту з можливістю вмикати вимикати конкретні зміни для синхронізації між різними версіями додатку. 
      - автосинхронізація через мережу
- ці варіанти мають бути присутні в меню на головному екрані 
- а краще зробити окремий діалог з іконками або bottomsheet для імпорту експорту і додати туди всі доступні дії і фічі
- забезпечити імпорт - експорт всіх сутностей. проектів, вкладень, скриптів, тд
- розглянути покращення моделі БД щодо вкладень 
- придумати спосіб уніфікувати формат json для всіх типів додатків. чи якусь єдину незмінну специфікацію розробити чи щось подібне. з жорсткими версіями. і вичерпним формальним описом який можна надати зокрема для розробки десктоп додатку
- треба уважно покрити тестами всі аспекти імпорту-експорту так щоб отримати супер-надійну фічу.
- не треба ніяких застарілих форматів. тільки канонічний єдиний формат і все

## 3. План дій
- зробити тестові бд на андроїд- і на десктоп-версіях. 2 проекти. по 4 цілей в кожному
- додати логи які весь процес синхронізації показують максимально детально. що передається. як це обробляється. які дії виконуються в результаті
- на основі цього віддебагувати синхронізаію в обидва боки
---

## 4. Невирішені проблеми / Блокери (PROBLEMS)
---

## 5. Значимі файли і модулі (IMPORTANT FILES / MODULES)
---

## 6. Інструкції та вимоги до стилю (INSTRUCTIONS)

- Не переписувати архітектуру без підтвердження  
- Виконувати лише один крок за раз  
- Не змінювати DI без дозволу  
- Додавати пропозицію оновлення контексту після кожної дії  
- Писати код, що точно компілюється  
- Завжди пояснювати причину помилки  

---

## 7. Замітки для агента (NOTES)
- ідеї в SYNAPSE_DESIGN.md, SYNC_FEATURE_SPEC.md
---

## 8. Після цього

--- 
codex resume 019adab2-2e46-7cc1-9be5-b7214f2f9e50

codex resume 019adaa2-b18b-74a1-b6d3-5e293026bb51
