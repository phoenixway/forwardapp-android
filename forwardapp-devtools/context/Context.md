## 1. Поточне завдання (CURRENT TASK)
- **Вирішено:** Проблема з некоректною взаємодією синхронізації та попереднього створення системних сутностей.
- **Вирішено:** Проблема з тим, що видалені цілі "оживали".
- **Вирішено:** Проблема з тим, що видалені проекти не зникали з UI на Android.
- **Вирішено:** Проблема з тим, що системні проекти некоректно синхронізувалися.

## 3. План дій
- [x] Проаналізовано логіку синхронізації (`SyncRepository.kt`) та ініціалізації (`DatabaseInitializer.kt`).
- [x] Виявлено, що вибірковий імпорт (`createSyncReport`, `importSelectedData`) ігнорував системні проекти, фільтруючи їх за `systemKey == null`.
- [x] Виявлено, що логіка `prePopulate` (`ensureProjectExists`) вже коректно перевіряє наявність системного проекту за `systemKey` і не створює дублікатів, якщо проект існує. Проблема виникала через те, що синхронізація не додавала ці проекти в базу.
- [x] **Виправлено:** Видалено фільтр `it.systemKey == null` з `createSyncReport` та `importSelectedData` в `SyncRepository.kt`.
- [x] **Виправлено:** Реалізовано спеціалізовану функцію `mergeSystemProjects` у `SyncRepository.kt`, яка дозволяє синхронізувати системні проекти на основі їх `systemKey`, зберігаючи локальний `id` та застосовуючи правила LWW до їх даних. Це вирішує проблему, коли системні проекти не синхронізувалися через розбіжності в `id` між пристроями.
- [x] **Результат:** Тепер синхронізація коректно обробляє системні проекти. Це, в свою чергу, вирішує проблему з `prePopulate`, оскільки тепер ця функція буде знаходити існуючі системні проекти, що надійшли через синхронізацію, і не буде створювати їх дублікати.

## 4. Невирішені проблеми / Блокери (PROBLEMS)
- Десктопний клієнт все ще може некоректно обробляти "tombstone" записи.

## 5. Значимі файли і модулі (IMPORTANT FILES / MODULES)
- `data/repository/SyncRepository.kt` - місце виправлення логіки вибіркової синхронізації та злиття системних проектів.
- `data/database/DatabaseInitializer.kt` - логіка попереднього створення, яка тепер має працювати коректно.

## 6. Інструкції та вимоги до стилю (INSTRUCTIONS)

- Не переписувати архітектуру без підтвердження  
- Виконувати лише один крок за раз  
- Не змінювати DI без дозволу  
- Додавати пропозицію оновлення контексту після кожної дії  
- Писати код, що точно компілюється  
- Завжди пояснювати причину помилки  

---

## 7. Замітки для агента (NOTES)
- ідеї в SYNAPSE_DESIGN.md, SYNC_FEATURE_SPEC.md
---

## 8. Після цього
- Можна прибрати додане логування з `GoalRepository` та `SyncRepository`.
---