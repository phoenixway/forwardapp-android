-- ================================================
-- üóÉ –û—Å–Ω–æ–≤–Ω–∞ —Ç–∞–±–ª–∏—Ü—è ActivityRecords
-- ================================================
CREATE TABLE ActivityRecords (
    id TEXT PRIMARY KEY,
    text TEXT NOT NULL,
    createdAt INTEGER NOT NULL,
    startTime INTEGER,
    endTime INTEGER,
    reminderTime INTEGER,
    targetId TEXT,
    targetType TEXT,
    goalId TEXT,
    projectId TEXT
);

-- ================================================
-- üîç FTS5 —Ç–∞–±–ª–∏—Ü—è (–±–µ–∑ content=, –±–µ–∑ rowid JOIN)
-- ================================================
CREATE VIRTUAL TABLE ActivityRecordsFts USING fts5(
    id UNINDEXED,      -- –∑–±–µ—Ä—ñ–≥–∞—î–º–æ id, –∞–ª–µ –Ω–µ —ñ–Ω–¥–µ–∫—Å—É—î–º–æ
    text               -- —Ç—ñ–ª—å–∫–∏ —Ç–µ–∫—Å—Ç —ñ–Ω–¥–µ–∫—Å—É—î—Ç—å—Å—è
);

-- ================================================
-- üîÑ –¢—Ä–∏–≥–µ—Ä–∏ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω FTS ‚Üî ActivityRecords
-- ================================================

-- INSERT
CREATE TRIGGER activityrecords_ai AFTER INSERT ON ActivityRecords
BEGIN
    INSERT INTO ActivityRecordsFts(id, text)
    VALUES (new.id, new.text);
END;

-- UPDATE
CREATE TRIGGER activityrecords_au AFTER UPDATE ON ActivityRecords
BEGIN
    DELETE FROM ActivityRecordsFts WHERE id = old.id;
    INSERT INTO ActivityRecordsFts(id, text)
    VALUES (new.id, new.text);
END;

-- DELETE
CREATE TRIGGER activityrecords_ad AFTER DELETE ON ActivityRecords
BEGIN
    DELETE FROM ActivityRecordsFts WHERE id = old.id;
END;

-- ================================================
-- ‚úÖ CRUD-–∑–∞–ø–∏—Ç–∏
-- ================================================

insert:
INSERT INTO ActivityRecords(id, text, createdAt, startTime, endTime, reminderTime, targetId, targetType, goalId, projectId)
VALUES (:id, :text, :createdAt, :startTime, :endTime, :reminderTime, :targetId, :targetType, :goalId, :projectId);

update:
UPDATE ActivityRecords SET
    text = :text,
    createdAt = :createdAt,
    startTime = :startTime,
    endTime = :endTime,
    reminderTime = :reminderTime,
    targetId = :targetId,
    targetType = :targetType,
    goalId = :goalId,
    projectId = :projectId
WHERE id = :id;

delete:
DELETE FROM ActivityRecords WHERE id = :id;

getById:
SELECT * FROM ActivityRecords WHERE id = :id;

getAll:
SELECT * FROM ActivityRecords ORDER BY createdAt DESC;

-- ================================================
-- üîé FTS-–ø–æ—à—É–∫ –ë–ï–ó JOIN (–±–µ–∑–ø–µ—á–Ω–∏–π –¥–ª—è SQLDelight)
-- ================================================
search:
SELECT id, text, createdAt, startTime, endTime, reminderTime, targetId, targetType, goalId, projectId
FROM ActivityRecords
WHERE id IN (
    SELECT rowid FROM ActivityRecordsFts
    WHERE ActivityRecordsFts MATCH ?1
)
ORDER BY createdAt DESC;
